@page "/"
@inject Sylvaro.Web.Services.SylvaroApiClient Api
@inject Sylvaro.Web.Services.AuthSession Session

<PageTitle>Executive Overview - Sylvaro</PageTitle>

@if (!Session.IsInitialized)
{
    <div class="card-shell"><p>Restoring secure session...</p></div>
}
else if (!Session.IsAuthenticated)
{
    <div class="card-shell"><p>Authentication required. Use <a href="/login">Sign In</a> to access compliance operations.</p></div>
}
else if (_loading)
{
    <div class="panel-grid">
        <section class="card-shell panel-span-12"><div class="skeleton"></div></section>
        <section class="card-shell panel-span-6"><div class="skeleton"></div></section>
        <section class="card-shell panel-span-6"><div class="skeleton"></div></section>
    </div>
}
else
{
    <div class="overview-shell">
        <div class="overview-head">
            <div>
                <span class="section-label">Executive Overview</span>
                <h1>Regulatory Posture Summary</h1>
                <p class="context-text">Institutional oversight across AI Act, GDPR, NIS2, control performance and evidence integrity.</p>
            </div>
            <div>
                <div class="status-line">
                    <span class="risk-pill info">Last Audit Event: @(_latestAudit?.ActionType ?? "N/A")</span>
                    <span class="risk-pill info">Assessment Version: @_latestVersionLabel</span>
                    <span class="risk-pill success">Signed-off By: @_latestSignoff</span>
                </div>
                <div class="btn-row" style="justify-content:flex-end; margin-bottom:0;">
                    <button class="btn-small" @onclick="ExportBoardSummaryAsync" disabled="@_exporting || _latestVersionId is null">Board Summary Export</button>
                    <button class="btn-main secondary" @onclick="ExportRegulatoryReportAsync" disabled="@_exporting || _latestVersionId is null">Regulatory Report Export</button>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <EnterpriseErrorPanel ErrorText="@_error" FriendlyMessage="Executive overview processing failed." OnRetry="LoadOverviewAsync" />
        }

        @if (!string.IsNullOrWhiteSpace(_exportMessage))
        {
            <div class="risk-pill success">@_exportMessage</div>
        }

        <section class="card-shell posture-summary">
            <div class="score-orb">
                <span class="score-caption">Compliance Score</span>
                <span class="score-value">@ComplianceScore</span>
                <span class="delta @DeltaClass(ScoreDelta)">@DeltaLabel(ScoreDelta)</span>
            </div>
            <div class="posture-grid">
                <article class="posture-item">
                    <header>
                        <span class="metric-label">AI Act Risk Classification</span>
                        <span class="delta @DeltaClass(AiActDelta)">@DeltaLabel(AiActDelta)</span>
                    </header>
                    <strong><span class="risk-pill @AiActRiskClassStyle">@AiActRiskClassLabel</span></strong>
                </article>
                <article class="posture-item">
                    <header>
                        <span class="metric-label">GDPR Exposure Level</span>
                        <span class="delta @DeltaClass(GdprDelta)">@DeltaLabel(GdprDelta)</span>
                    </header>
                    <strong><span class="risk-pill @GdprExposureStyle">@GdprExposureLevel</span></strong>
                </article>
                <article class="posture-item">
                    <header>
                        <span class="metric-label">NIS2 Applicability</span>
                        <span class="delta @DeltaClass(Nis2Delta)">@DeltaLabel(Nis2Delta)</span>
                    </header>
                    <strong><span class="risk-pill @Nis2Style">@Nis2Applicability</span></strong>
                </article>
                <article class="posture-item">
                    <header>
                        <span class="metric-label">Control Coverage %</span>
                        <span class="delta @DeltaClass(ControlCoverageDelta)">@DeltaLabel(ControlCoverageDelta)</span>
                    </header>
                    <strong>@ControlCoveragePercent%</strong>
                </article>
            </div>
        </section>

        <div class="panel-grid">
            <section class="card-shell panel-span-4">
                <span class="section-label">Risk Distribution</span>
                <h2>Regulatory Exposure Breakdown</h2>
                <div class="donut-chart" style="@DonutGradientStyle">
                    <div class="donut-center">@RiskTotal</div>
                </div>
                <div class="legend-grid">
                    @foreach (var bucket in RiskBreakdown)
                    {
                        <div class="legend-item @bucket.CssClass">
                            <span><i></i>@bucket.Label</span>
                            <strong>@bucket.Count (@bucket.Percentage%)</strong>
                        </div>
                    }
                </div>
            </section>

            <section class="card-shell panel-span-8">
                <span class="section-label">Regulatory Exposure Matrix</span>
                <h2>Component-Level Regulatory Matrix</h2>
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>AI Act</th>
                            <th>GDPR</th>
                            <th>Security</th>
                            <th>Vendor</th>
                            <th>Operational</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in _componentRiskRows)
                        {
                            <tr>
                                <td>@row.Component</td>
                                <td>
                                    <div class="matrix-cell @ToSeverityClass(row.AiAct.Severity)">
                                        <span>@row.AiAct.Severity</span>
                                        <div class="matrix-hint">Issue: @row.AiAct.Issue<br />Control: @row.AiAct.Control<br />Evidence: @row.AiAct.EvidenceStatus</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="matrix-cell @ToSeverityClass(row.Gdpr.Severity)">
                                        <span>@row.Gdpr.Severity</span>
                                        <div class="matrix-hint">Issue: @row.Gdpr.Issue<br />Control: @row.Gdpr.Control<br />Evidence: @row.Gdpr.EvidenceStatus</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="matrix-cell @ToSeverityClass(row.Security.Severity)">
                                        <span>@row.Security.Severity</span>
                                        <div class="matrix-hint">Issue: @row.Security.Issue<br />Control: @row.Security.Control<br />Evidence: @row.Security.EvidenceStatus</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="matrix-cell @ToSeverityClass(row.Vendor.Severity)">
                                        <span>@row.Vendor.Severity</span>
                                        <div class="matrix-hint">Issue: @row.Vendor.Issue<br />Control: @row.Vendor.Control<br />Evidence: @row.Vendor.EvidenceStatus</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="matrix-cell @ToSeverityClass(row.Operational.Severity)">
                                        <span>@row.Operational.Severity</span>
                                        <div class="matrix-hint">Issue: @row.Operational.Issue<br />Control: @row.Operational.Control<br />Evidence: @row.Operational.EvidenceStatus</div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </section>

            <section class="card-shell panel-span-12">
                <span class="section-label">Governance Status</span>
                <h2>Control and Obligation Health</h2>
                <div class="governance-grid">
                    <article class="governance-card">
                        <span class="metric-label">Outstanding Obligations</span>
                        <span class="metric-value">@OutstandingActions</span>
                        <span class="delta @DeltaClass(ObligationsDelta)">@DeltaLabel(ObligationsDelta)</span>
                        <span class="distribution">Critical/High: @HighPriorityActionCount of @_actions.Count</span>
                    </article>
                    <article class="governance-card">
                        <span class="metric-label">Critical Control Deficiencies</span>
                        <span class="metric-value">@OpenCriticalActions</span>
                        <span class="delta @DeltaClass(CriticalDeficiencyDelta)">@DeltaLabel(CriticalDeficiencyDelta)</span>
                        <span class="distribution">Open critical controls requiring immediate sign-off.</span>
                    </article>
                    <article class="governance-card">
                        <span class="metric-label">Overdue Remediations</span>
                        <span class="metric-value">@OverdueRemediationCount</span>
                        <span class="delta @DeltaClass(OverdueDelta)">@DeltaLabel(OverdueDelta)</span>
                        <span class="distribution">Due date violations in active remediation workflow.</span>
                    </article>
                    <article class="governance-card">
                        <span class="metric-label">Evidence Gaps</span>
                        <span class="metric-value">@EvidenceGapCount</span>
                        <span class="delta @DeltaClass(EvidenceGapDelta)">@DeltaLabel(EvidenceGapDelta)</span>
                        <span class="distribution">Findings currently missing reliable supporting evidence.</span>
                    </article>
                </div>
            </section>
        </div>
    </div>
}

@code {
    private bool _loading = true;
    private bool _exporting;
    private bool _attemptedInitialLoad;
    private string _error = string.Empty;
    private string _exportMessage = string.Empty;

    private Sylvaro.Web.Models.DashboardTenantDto? _dashboard;
    private Sylvaro.Web.Models.DashboardSystemDto? _systemDashboard;
    private Sylvaro.Web.Models.AuditLogDto? _latestAudit;
    private List<Sylvaro.Web.Models.AiSystemListItem> _systems = [];
    private List<Sylvaro.Web.Models.VersionSummaryDto> _versions = [];
    private List<Sylvaro.Web.Models.AssessmentListItem> _assessments = [];
    private List<Sylvaro.Web.Models.ActionItemDto> _actions = [];
    private List<Sylvaro.Web.Models.FindingDto> _latestFindings = [];
    private Sylvaro.Web.Models.InventoryResponse _inventory = new([], []);
    private List<ComponentRiskRow> _componentRiskRows = [];

    private int _vendorOutsideEu;
    private string _latestVersionLabel = "N/A";
    private string _latestSignoff = "Pending";
    private Guid? _latestVersionId;

    private int ComplianceScore => _systemDashboard?.ScoreTrend.OrderBy(x => x.RanAt).LastOrDefault()?.Score ?? 0;
    private int ScoreDelta
        => _systemDashboard?.ScoreTrend is { Count: > 1 }
            ? _systemDashboard.ScoreTrend.OrderBy(x => x.RanAt).TakeLast(2).Last().Score - _systemDashboard.ScoreTrend.OrderBy(x => x.RanAt).TakeLast(2).First().Score
            : 0;

    private int OutstandingActions => _dashboard?.OpenActions ?? 0;
    private int OpenCriticalActions => _actions.Count(a => a.Priority.Equals("Critical", StringComparison.OrdinalIgnoreCase));
    private int RiskTotal => RiskBreakdown.Sum(x => x.Count);
    private int ControlCoveragePercent => _actions.Count == 0
        ? 0
        : (int)Math.Round(100d * _actions.Count(a => a.Status.Equals("Done", StringComparison.OrdinalIgnoreCase)) / _actions.Count);
    private int ControlCoverageDelta => Math.Clamp(ScoreDelta / 3, -3, 3);
    private int ObligationsDelta => Math.Clamp(ScoreDelta == 0 ? 0 : -Math.Sign(ScoreDelta), -2, 2);
    private int CriticalDeficiencyDelta => Math.Clamp(ScoreDelta == 0 ? 0 : -Math.Sign(ScoreDelta), -2, 2);
    private int OverdueRemediationCount => _actions.Count(a =>
        a.DueDate.HasValue &&
        a.DueDate.Value < DateTimeOffset.UtcNow &&
        !a.Status.Equals("Done", StringComparison.OrdinalIgnoreCase));
    private int OverdueDelta => OverdueRemediationCount == 0 ? -1 : 1;
    private int EvidenceGapCount => _latestFindings.Count(f =>
        f.Severity.Equals("Critical", StringComparison.OrdinalIgnoreCase) ||
        f.Severity.Equals("High", StringComparison.OrdinalIgnoreCase));
    private int EvidenceGapDelta => EvidenceGapCount == 0 ? -1 : 1;
    private int HighPriorityActionCount => _actions.Count(a =>
        a.Priority.Equals("Critical", StringComparison.OrdinalIgnoreCase) ||
        a.Priority.Equals("High", StringComparison.OrdinalIgnoreCase));

    private string AiActRiskClassLabel => _dashboard?.RiskDistribution.Keys.FirstOrDefault(x =>
        x.Contains("prohibited", StringComparison.OrdinalIgnoreCase) ||
        x.Contains("high", StringComparison.OrdinalIgnoreCase) ||
        x.Contains("limited", StringComparison.OrdinalIgnoreCase) ||
        x.Contains("minimal", StringComparison.OrdinalIgnoreCase)) ?? "minimal";

    private string AiActRiskClassStyle => ToRiskPill(AiActRiskClassLabel);
    private string GdprExposureLevel => OutstandingActions >= 10 ? "High" : OutstandingActions >= 4 ? "Moderate" : "Low";
    private string GdprExposureStyle => ToRiskPill(GdprExposureLevel);
    private string Nis2Applicability => _inventory.Vendors.Any() ? "Applicable" : "Under Review";
    private string Nis2Style => _inventory.Vendors.Any() ? "medium" : "low";
    private int AiActDelta => Math.Clamp(-Math.Sign(ScoreDelta), -2, 2);
    private int GdprDelta => ObligationsDelta;
    private int Nis2Delta => _vendorOutsideEu > 0 ? 1 : 0;

    private IReadOnlyList<RiskLegendBucket> RiskBreakdown
    {
        get
        {
            var distribution = _dashboard?.RiskDistribution ?? new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);
            var buckets = new List<RiskLegendBucket>
            {
                new("Critical", "critical", CountKeys(distribution, "critical", "prohibited"), "#7A2F2F"),
                new("High", "high", CountKeys(distribution, "high"), "#9A4437"),
                new("Medium", "medium", CountKeys(distribution, "limited", "medium"), "#8B6533"),
                new("Low", "low", CountKeys(distribution, "minimal", "low"), "#6F5C47"),
                new("Compliant", "compliant", Math.Max(0, _actions.Count(a => a.Status.Equals("Done", StringComparison.OrdinalIgnoreCase))), "#4F6842")
            };

            var total = Math.Max(1, buckets.Sum(x => x.Count));
            return buckets.Select(x => x with { Percentage = (int)Math.Round(100d * x.Count / total) }).ToList();
        }
    }

    private string DonutGradientStyle
    {
        get
        {
            var pointer = 0;
            var segments = new List<string>();
            foreach (var item in RiskBreakdown)
            {
                var end = Math.Min(100, pointer + item.Percentage);
                segments.Add($"{item.ColorHex} {pointer}% {end}%");
                pointer = end;
            }

            if (pointer < 100)
            {
                segments.Add($"#4F6842 {pointer}% 100%");
            }

            return $"--donut-gradient: conic-gradient({string.Join(",", segments)});";
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (!Session.IsAuthenticated)
        {
            _loading = false;
            return;
        }

        _attemptedInitialLoad = true;
        await LoadOverviewAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_attemptedInitialLoad || !Session.IsInitialized || !Session.IsAuthenticated)
        {
            return;
        }

        _attemptedInitialLoad = true;
        _loading = true;
        await LoadOverviewAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadOverviewAsync()
    {
        try
        {
            _dashboard = await Api.GetAsync<Sylvaro.Web.Models.DashboardTenantDto>("/dashboard/tenant");
            _systems = (await Api.GetAsync<List<Sylvaro.Web.Models.AiSystemListItem>>("/aisystems")) ?? [];
            _latestAudit = (await Api.GetAsync<List<Sylvaro.Web.Models.AuditLogDto>>("/audit?take=1"))?.FirstOrDefault();

            var primarySystem = _systems.OrderByDescending(x => x.UpdatedAt).FirstOrDefault();
            if (primarySystem is null)
            {
                return;
            }

            _systemDashboard = await Api.GetAsync<Sylvaro.Web.Models.DashboardSystemDto>($"/dashboard/system/{primarySystem.Id}");

            _versions = (await Api.GetAsync<List<Sylvaro.Web.Models.VersionSummaryDto>>($"/aisystems/{primarySystem.Id}/versions")) ?? [];
            var latestVersion = _versions.OrderByDescending(x => x.VersionNumber).FirstOrDefault();
            if (latestVersion is null)
            {
                return;
            }

            _latestVersionId = latestVersion.Id;
            _latestVersionLabel = $"v{latestVersion.VersionNumber}";
            _assessments = (await Api.GetAsync<List<Sylvaro.Web.Models.AssessmentListItem>>($"/versions/{latestVersion.Id}/assessments")) ?? [];
            _actions = (await Api.GetAsync<List<Sylvaro.Web.Models.ActionItemDto>>($"/actions/version/{latestVersion.Id}")) ?? [];
            _inventory = await Api.GetAsync<Sylvaro.Web.Models.InventoryResponse>($"/versions/{latestVersion.Id}/inventory") ?? new([], []);
            var architecture = await Api.GetAsync<Sylvaro.Web.Models.ArchitectureResponse>($"/versions/{latestVersion.Id}/architecture") ?? new([], [], []);

            _componentRiskRows = architecture.Components
                .OrderBy(x => x.Name)
                .Take(12)
                .Select(component => BuildComponentRiskRow(component, architecture, _inventory))
                .ToList();

            _vendorOutsideEu = _inventory.Vendors.Count(v => !v.Region.Contains("eu", StringComparison.OrdinalIgnoreCase));

            _latestSignoff = _actions
                .Where(a => a.ApprovedBy.HasValue)
                .OrderByDescending(a => a.ApprovedAt)
                .Select(a => a.ApprovedBy!.Value.ToString()[..8])
                .FirstOrDefault() ?? "Pending";

            var latestAssessment = _assessments.OrderByDescending(x => x.RanAt).FirstOrDefault();
            if (latestAssessment is not null)
            {
                _latestFindings = (await Api.GetAsync<List<Sylvaro.Web.Models.FindingDto>>($"/findings/assessment/{latestAssessment.Id}")) ?? [];
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ExportBoardSummaryAsync()
        => await GenerateDashboardExportAsync("Board_Summary", "json");

    private async Task ExportRegulatoryReportAsync()
        => await GenerateDashboardExportAsync("Regulator_Export", "pdf");

    private async Task GenerateDashboardExportAsync(string exportType, string format)
    {
        if (_latestVersionId is null)
        {
            return;
        }

        try
        {
            _exporting = true;
            _error = string.Empty;
            _exportMessage = string.Empty;

            var result = await Api.PostAsync<DashboardExportResult>($"/exports/versions/{_latestVersionId.Value}/generate", new
            {
                exportType,
                format,
                sendWebhook = false
            });

            if (result is null)
            {
                _error = "Export generation did not return an artifact reference.";
                return;
            }

            _exportMessage = $"Generated {result.ExportType} ({result.MimeType}) at {result.CreatedAt:yyyy-MM-dd HH:mm:ss} UTC.";
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _exporting = false;
        }
    }

    private static int CountKeys(IReadOnlyDictionary<string, int> distribution, params string[] fragments)
        => distribution
            .Where(kvp => fragments.Any(fragment => kvp.Key.Contains(fragment, StringComparison.OrdinalIgnoreCase)))
            .Sum(kvp => kvp.Value);

    private static string ToRiskPill(string severity)
        => severity.ToLowerInvariant() switch
        {
            var value when value.Contains("critical") || value.Contains("prohibited") => "critical",
            var value when value.Contains("high") => "high",
            var value when value.Contains("medium") || value.Contains("limited") || value.Contains("moderate") => "medium",
            var value when value.Contains("compliant") => "compliant",
            _ => "low"
        };

    private static ComponentRiskRow BuildComponentRiskRow(
        Sylvaro.Web.Models.ComponentDto component,
        Sylvaro.Web.Models.ArchitectureResponse architecture,
        Sylvaro.Web.Models.InventoryResponse inventory)
    {
        var hasSensitiveFlow = architecture.Flows.Any(flow =>
            (flow.FromComponentId == component.Id || flow.ToComponentId == component.Id) &&
            flow.DataCategories.Any(category =>
                category.Contains("personal", StringComparison.OrdinalIgnoreCase) ||
                category.Contains("financial", StringComparison.OrdinalIgnoreCase)));

        var aiActSeverity = component.Type.Contains("llm", StringComparison.OrdinalIgnoreCase) ||
                            component.Type.Contains("analytics", StringComparison.OrdinalIgnoreCase)
            ? "High"
            : "Medium";

        var gdprSeverity = hasSensitiveFlow || component.DataSensitivityLevel.Contains("high", StringComparison.OrdinalIgnoreCase)
            ? "High"
            : component.DataSensitivityLevel.Contains("medium", StringComparison.OrdinalIgnoreCase) ? "Medium" : "Low";

        var securitySeverity = component.IsExternal || component.TrustZone.Contains("external", StringComparison.OrdinalIgnoreCase)
            ? "High"
            : component.TrustZone.Contains("dmz", StringComparison.OrdinalIgnoreCase) ? "Medium" : "Low";

        var vendorSeverity = component.IsExternal || inventory.Vendors.Any(vendor =>
            component.Name.Contains(vendor.Name, StringComparison.OrdinalIgnoreCase) ||
            vendor.ServiceType.Contains("llm", StringComparison.OrdinalIgnoreCase))
            ? "High"
            : "Low";

        var operationalSeverity = architecture.Stores.Any(store => store.ComponentId == component.Id && store.RetentionDays > 1800)
            ? "Medium"
            : "Compliant";

        return new ComponentRiskRow(
            component.Name,
            BuildMatrixCell(aiActSeverity, "Potential high-impact AI obligations identified.", "AI_ACT_HIGH_RISK_CONTROLS", "Policy reference aligned"),
            BuildMatrixCell(gdprSeverity, "Personal data processing requires lawful basis controls.", "GDPR_LAWFUL_BASIS_REVIEW", hasSensitiveFlow ? "Evidence required" : "Evidence linked"),
            BuildMatrixCell(securitySeverity, "Attack surface exposure across trust boundaries.", "NIS2_ACCESS_AND_LOGGING_BASELINE", component.IsExternal ? "Partial evidence" : "Evidence linked"),
            BuildMatrixCell(vendorSeverity, "Third-party dependency and processor risk.", "VENDOR_DPA_AND_REGION_CHECK", inventory.Vendors.Count == 0 ? "Evidence missing" : "Evidence linked"),
            BuildMatrixCell(operationalSeverity, "Retention and continuity operating controls.", "OPERATIONS_RETENTION_CONTINUITY", operationalSeverity.Equals("Compliant", StringComparison.OrdinalIgnoreCase) ? "Evidence linked" : "Evidence required"));
    }

    private static MatrixCell BuildMatrixCell(string severity, string issue, string control, string evidence)
        => new(severity, issue, control, evidence);

    private static string DeltaClass(int value)
        => value switch
        {
            > 0 => "up",
            < 0 => "down",
            _ => "flat"
        };

    private static string DeltaLabel(int value)
        => value switch
        {
            > 0 => $"▲ +{value}",
            < 0 => $"▼ {value}",
            _ => "• 0"
        };

    private static string ToSeverityClass(string severity)
        => ToRiskPill(severity);

    private sealed record RiskLegendBucket(string Label, string CssClass, int Count, string ColorHex)
    {
        public int Percentage { get; init; }
    }

    private sealed record MatrixCell(string Severity, string Issue, string Control, string EvidenceStatus);
    private sealed record ComponentRiskRow(string Component, MatrixCell AiAct, MatrixCell Gdpr, MatrixCell Security, MatrixCell Vendor, MatrixCell Operational);
    private sealed record DashboardExportResult(Guid Id, string ExportType, string MimeType, DateTimeOffset CreatedAt);
}
