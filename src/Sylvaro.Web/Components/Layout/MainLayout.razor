@inherits LayoutComponentBase
@inject Sylvaro.Web.Services.AuthSession Session
@inject NavigationManager Nav
@inject IJSRuntime JsRuntime
@implements IDisposable

<div class="app-shell">
    <aside class="sidebar-panel">
        <NavMenu />
    </aside>

    <main class="main-panel">
        <header class="governance-topbar">
            <div class="topbar-left">
                <img class="wordmark-image" src="/brand/sylvaro-wordmark.svg" alt="SYLVARO" />
                <span class="brand-sub">Compliance Intelligence Infrastructure</span>
            </div>

            <div class="topbar-center">
                <span class="context-kicker">Current system context</span>
                <strong>@CurrentContextLabel</strong>
            </div>

            <div class="topbar-right">
                @if (Session.IsAuthenticated)
                {
                    <span class="session-chip">Tenant: @Session.TenantName</span>
                    <span class="session-chip">User: @Session.Email</span>
                    <span class="session-chip">Role: @PrimaryRole</span>
                    <details class="session-menu">
                        <summary>Session</summary>
                        <div class="session-menu-panel">
                            <p><strong>Last login</strong><br />@FormatTimestamp(Session.LastAuthenticatedAt)</p>
                            <p><strong>Expires</strong><br />@FormatTimestamp(Session.RefreshTokenExpiresAt)</p>
                            <p><strong>Status</strong><br />Active authenticated session</p>
                        </div>
                    </details>
                }
                else
                {
                    <span class="session-chip">Public access</span>
                }
            </div>
        </header>

        <article class="content-panel">
            @if (!Session.IsInitialized)
            {
                <div class="card-shell"><p>Restoring secure session...</p></div>
            }
            else
            {
                @Body
            }
        </article>

        <footer class="platform-footer">
            <span>SYLVARO | Compliance Intelligence Platform</span>
            <span>Version 1.1.0 | Policy Pack Version 2026.1</span>
        </footer>
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">x</span>
</div>

@code {
    private bool _didInitialSessionRestore;
    private string _currentPath = "/";

    protected override void OnInitialized()
    {
        _currentPath = Nav.ToBaseRelativePath(Nav.Uri);
        Session.Changed += OnSessionChanged;
        Nav.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _didInitialSessionRestore)
        {
            return;
        }

        _didInitialSessionRestore = true;
        await Session.EnsureInitializedAsync(JsRuntime);
    }

    private void OnSessionChanged() => InvokeAsync(StateHasChanged);

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        _currentPath = Nav.ToBaseRelativePath(e.Location);
        _ = InvokeAsync(StateHasChanged);
    }

    private static string FormatTimestamp(DateTimeOffset value)
        => value == default ? "n/a" : value.UtcDateTime.ToString("yyyy-MM-dd HH:mm:ss 'UTC'");

    private string CurrentContextLabel
        => _currentPath switch
        {
            var path when path.StartsWith("ai-systems/", StringComparison.OrdinalIgnoreCase) => "AI System Governance Workspace",
            var path when path.StartsWith("ai-systems", StringComparison.OrdinalIgnoreCase) => "AI Systems Inventory",
            var path when path.StartsWith("regulatory-exposure", StringComparison.OrdinalIgnoreCase) => "Regulatory Exposure Matrix",
            var path when path.StartsWith("controls-actions", StringComparison.OrdinalIgnoreCase) => "Controls and Obligations",
            var path when path.StartsWith("evidence-vault", StringComparison.OrdinalIgnoreCase) => "Evidence Vault",
            var path when path.StartsWith("tenant-settings", StringComparison.OrdinalIgnoreCase) => "Tenant Governance Configuration",
            var path when path.StartsWith("audit-log", StringComparison.OrdinalIgnoreCase) => "Regulatory Audit Trail",
            var path when path.StartsWith("security-center", StringComparison.OrdinalIgnoreCase) => "Security Governance Center",
            _ => "Executive Regulatory Oversight"
        };

    private string PrimaryRole
    {
        get
        {
            if (string.IsNullOrWhiteSpace(Session.AccessToken))
            {
                return "Unassigned";
            }

            try
            {
                var parts = Session.AccessToken.Split('.');
                if (parts.Length < 2)
                {
                    return "Unassigned";
                }

                var payload = parts[1]
                    .Replace('-', '+')
                    .Replace('_', '/');
                payload = payload.PadRight(payload.Length + (4 - payload.Length % 4) % 4, '=');
                var json = System.Text.Encoding.UTF8.GetString(Convert.FromBase64String(payload));
                using var doc = System.Text.Json.JsonDocument.Parse(json);

                if (doc.RootElement.TryGetProperty("role", out var roleElement))
                {
                    if (roleElement.ValueKind == System.Text.Json.JsonValueKind.String)
                    {
                        return roleElement.GetString() ?? "Unassigned";
                    }

                    if (roleElement.ValueKind == System.Text.Json.JsonValueKind.Array)
                    {
                        var first = roleElement.EnumerateArray().FirstOrDefault();
                        if (first.ValueKind == System.Text.Json.JsonValueKind.String)
                        {
                            return first.GetString() ?? "Unassigned";
                        }
                    }
                }

                var schemaRole = "http://schemas.microsoft.com/ws/2008/06/identity/claims/role";
                if (doc.RootElement.TryGetProperty(schemaRole, out var schemaRoleElement) &&
                    schemaRoleElement.ValueKind == System.Text.Json.JsonValueKind.String)
                {
                    return schemaRoleElement.GetString() ?? "Unassigned";
                }
            }
            catch
            {
                // Keep a resilient display if token parsing fails.
            }

            return "Unassigned";
        }
    }

    public void Dispose()
    {
        Session.Changed -= OnSessionChanged;
        Nav.LocationChanged -= OnLocationChanged;
    }
}
