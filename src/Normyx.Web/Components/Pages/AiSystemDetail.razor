@page "/ai-systems/{SystemId:guid}"
@inject Normyx.Web.Services.NormyxApiClient Api
@inject Normyx.Web.Services.AuthSession Session

<PageTitle>AI System Detail - Normyx AI</PageTitle>

@if (!Session.IsAuthenticated)
{
    <div class="card-shell"><p>Please <a href="/login">log in</a>.</p></div>
}
else if (_loading)
{
    <div class="card-shell"><p>Loading system...</p></div>
}
else if (_system is null)
{
    <div class="card-shell"><p>System not found.</p></div>
}
else
{
    <div class="card-shell">
        <h1>@_system.Name</h1>
        <p>@_system.Description</p>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <div class="alert-danger">@_error</div>
        }

        @if (_currentVersionId is not null)
        {
            <div class="btn-row">
                <button class="btn-main" @onclick="RunAssessmentAsync">Run Assessment</button>
                <button class="btn-main secondary" @onclick="GenerateExportAsync">Generate PDF Export</button>
            </div>

            @if (_lastRun is not null)
            {
                <p>Latest run: class=@_lastRun.AiActRiskClass score=@_lastRun.ComplianceScore findings=@_lastRun.FindingsCount actions=@_lastRun.ActionsCount</p>
            }
        }

        <h2>Versions</h2>
        <ul>
            @foreach (var version in _versions)
            {
                <li>
                    v@version.VersionNumber - @version.ChangeSummary
                    <button class="btn-small" @onclick="() => SelectVersionAsync(version.Id)">Use</button>
                </li>
            }
        </ul>

        @if (_currentVersionId is not null)
        {
            <h2>Questionnaire</h2>
            <EditForm Model="_questionnaire" OnValidSubmit="SaveQuestionnaireAsync">
                <div class="field-grid">
                    <InputText @bind-Value="_questionnaire.AutomatedDecisionMaking" class="text-input" placeholder="automatedDecisionMaking true/false" />
                    <InputText @bind-Value="_questionnaire.CriticalSector" class="text-input" placeholder="criticalSector true/false" />
                </div>
                <button class="btn-small" type="submit">Save questionnaire</button>
            </EditForm>

            <h2>Architecture Components (@_architecture.Components.Count)</h2>
            <ul>
                @foreach (var component in _architecture.Components)
                {
                    <li>@component.Name (@component.Type) - @component.TrustZone - @component.DataSensitivityLevel</li>
                }
            </ul>

            <h3>Add component</h3>
            <EditForm Model="_newComponent" OnValidSubmit="AddComponentAsync">
                <div class="field-grid">
                    <InputText @bind-Value="_newComponent.Name" class="text-input" placeholder="Component name" />
                    <InputText @bind-Value="_newComponent.Type" class="text-input" placeholder="Type" />
                    <InputText @bind-Value="_newComponent.TrustZone" class="text-input" placeholder="Trust zone" />
                    <InputText @bind-Value="_newComponent.DataSensitivityLevel" class="text-input" placeholder="Sensitivity" />
                </div>
                <button class="btn-small" type="submit">Add component</button>
            </EditForm>

            <h2>Data & Vendors</h2>
            <p>Data items: @_inventory.DataItems.Count | Vendors: @_inventory.Vendors.Count</p>

            <h2>Evidence Upload</h2>
            <InputFile OnChange="UploadDocumentAsync" />
            @if (!string.IsNullOrWhiteSpace(_uploadMessage))
            {
                <p>@_uploadMessage</p>
            }

            <h2>Assessments</h2>
            <ul>
                @foreach (var assessment in _assessments)
                {
                    <li>@assessment.RanAt.ToString("u") - @assessment.RiskScoresJson</li>
                }
            </ul>

            <h2>Findings (@_findings.Count)</h2>
            <ul>
                @foreach (var finding in _findings)
                {
                    <li>[ @finding.Severity ] @finding.Title</li>
                }
            </ul>

            <h2>Actions (@_actions.Count)</h2>
            <ul>
                @foreach (var action in _actions)
                {
                    <li>[ @action.Priority ] @action.Title - @action.Status</li>
                }
            </ul>
        }
    </div>
}

@code {
    [Parameter] public Guid SystemId { get; set; }

    private bool _loading = true;
    private string _error = string.Empty;
    private string _uploadMessage = string.Empty;

    private Normyx.Web.Models.AiSystemDetailDto? _system;
    private List<Normyx.Web.Models.VersionSummaryDto> _versions = [];
    private Guid? _currentVersionId;
    private Normyx.Web.Models.ArchitectureResponse _architecture = new([], [], []);
    private Normyx.Web.Models.InventoryResponse _inventory = new([], []);
    private List<Normyx.Web.Models.AssessmentListItem> _assessments = [];
    private List<Normyx.Web.Models.FindingDto> _findings = [];
    private List<Normyx.Web.Models.ActionItemDto> _actions = [];
    private Normyx.Web.Models.AssessmentRunResult? _lastRun;

    private readonly QuestionnaireForm _questionnaire = new();
    private readonly NewComponentForm _newComponent = new();

    protected override async Task OnParametersSetAsync()
    {
        if (!Session.IsAuthenticated)
        {
            _loading = false;
            return;
        }

        _loading = true;
        await LoadSystemAsync();
        _loading = false;
    }

    private async Task LoadSystemAsync()
    {
        try
        {
            _error = string.Empty;
            _system = await Api.GetAsync<Normyx.Web.Models.AiSystemDetailDto>($"/aisystems/{SystemId}");
            _versions = (await Api.GetAsync<List<Normyx.Web.Models.VersionSummaryDto>>($"/aisystems/{SystemId}/versions")) ?? [];

            if (_currentVersionId is null)
            {
                _currentVersionId = _versions.OrderByDescending(x => x.VersionNumber).FirstOrDefault()?.Id;
            }

            if (_currentVersionId is not null)
            {
                await LoadVersionDataAsync(_currentVersionId.Value);
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task SelectVersionAsync(Guid versionId)
    {
        _currentVersionId = versionId;
        await LoadVersionDataAsync(versionId);
    }

    private async Task LoadVersionDataAsync(Guid versionId)
    {
        _architecture = await Api.GetAsync<Normyx.Web.Models.ArchitectureResponse>($"/versions/{versionId}/architecture") ?? new([], [], []);
        _inventory = await Api.GetAsync<Normyx.Web.Models.InventoryResponse>($"/versions/{versionId}/inventory") ?? new([], []);
        _assessments = (await Api.GetAsync<List<Normyx.Web.Models.AssessmentListItem>>($"/versions/{versionId}/assessments")) ?? [];
        _actions = (await Api.GetAsync<List<Normyx.Web.Models.ActionItemDto>>($"/actions/version/{versionId}")) ?? [];

        if (_assessments.Count > 0)
        {
            var latest = _assessments.OrderByDescending(x => x.RanAt).First();
            _findings = (await Api.GetAsync<List<Normyx.Web.Models.FindingDto>>($"/findings/assessment/{latest.Id}")) ?? [];
        }
        else
        {
            _findings = [];
        }
    }

    private async Task RunAssessmentAsync()
    {
        if (_currentVersionId is null)
        {
            return;
        }

        try
        {
            _lastRun = await Api.PostAsync<Normyx.Web.Models.AssessmentRunResult>($"/versions/{_currentVersionId}/assessments/run", new { });
            await LoadVersionDataAsync(_currentVersionId.Value);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task GenerateExportAsync()
    {
        if (_currentVersionId is null)
        {
            return;
        }

        try
        {
            var export = await Api.PostAsync<Normyx.Web.Models.ExportArtifactDto>($"/exports/versions/{_currentVersionId}/generate", new { exportType = "DPIA_Draft" });
            if (export is not null)
            {
                _uploadMessage = $"Export generated: {export.Id}";
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task SaveQuestionnaireAsync()
    {
        if (_currentVersionId is null)
        {
            return;
        }

        try
        {
            await Api.PutAsync($"/versions/{_currentVersionId}/questionnaire", new
            {
                answers = new Dictionary<string, string>
                {
                    ["automatedDecisionMaking"] = _questionnaire.AutomatedDecisionMaking,
                    ["criticalSector"] = _questionnaire.CriticalSector
                }
            });
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task AddComponentAsync()
    {
        if (_currentVersionId is null)
        {
            return;
        }

        try
        {
            await Api.PostAsync($"/versions/{_currentVersionId}/architecture/components", new
            {
                name = _newComponent.Name,
                type = _newComponent.Type,
                description = _newComponent.Description,
                trustZone = _newComponent.TrustZone,
                isExternal = _newComponent.IsExternal,
                dataSensitivityLevel = _newComponent.DataSensitivityLevel
            });

            _newComponent.Reset();
            await LoadVersionDataAsync(_currentVersionId.Value);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task UploadDocumentAsync(InputFileChangeEventArgs args)
    {
        try
        {
            var file = args.File;
            var response = await Api.UploadFileAsync<Normyx.Web.Models.DocumentUploadResponse>("/documents/upload", file, "evidence,demo");
            _uploadMessage = response is null ? "Upload complete." : $"Uploaded: {response.FileName}";
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private sealed class QuestionnaireForm
    {
        public string AutomatedDecisionMaking { get; set; } = "true";
        public string CriticalSector { get; set; } = "true";
    }

    private sealed class NewComponentForm
    {
        public string Name { get; set; } = string.Empty;
        public string Type { get; set; } = "Service";
        public string Description { get; set; } = string.Empty;
        public string TrustZone { get; set; } = "Internal";
        public bool IsExternal { get; set; }
        public string DataSensitivityLevel { get; set; } = "Medium";

        public void Reset()
        {
            Name = string.Empty;
            Type = "Service";
            Description = string.Empty;
            TrustZone = "Internal";
            IsExternal = false;
            DataSensitivityLevel = "Medium";
        }
    }
}
