@page "/register"
@inject Normyx.Web.Services.NormyxApiClient Api
@inject Normyx.Web.Services.AuthSession Session
@inject NavigationManager Nav
@inject IJSRuntime JsRuntime

<PageTitle>Register - Normyx AI</PageTitle>

<div class="card-shell narrow">
    <h1>Create Tenant</h1>
    <p>Register a tenant and admin user.</p>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="alert-danger">@_error</div>
    }

    <EditForm FormName="register-form" Model="_model" OnValidSubmit="OnSubmitAsync">
        <div class="field">
            <label>Tenant Name</label>
            <InputText @bind-Value="_model.TenantName" class="text-input" />
        </div>
        <div class="field">
            <label>Email</label>
            <InputText @bind-Value="_model.Email" class="text-input" />
        </div>
        <div class="field">
            <label>Display Name</label>
            <InputText @bind-Value="_model.DisplayName" class="text-input" />
        </div>
        <div class="field">
            <label>Password</label>
            <InputText @bind-Value="_model.Password" type="password" class="text-input" />
        </div>
        <button class="btn-main" type="submit" disabled="@_loading">@(_loading ? "Creating..." : "Create tenant")</button>
    </EditForm>
</div>

@code {
    private readonly RegisterModel _model = new("", "", "", "");
    private bool _loading;
    private string _error = string.Empty;

    private async Task OnSubmitAsync()
    {
        try
        {
            _loading = true;
            _error = string.Empty;

            var response = await Api.PostAsync<Normyx.Web.Models.AuthResponse>("/auth/register", new
            {
                tenantName = _model.TenantName,
                email = _model.Email,
                displayName = _model.DisplayName,
                password = _model.Password
            }, withAuth: false);

            if (response is null)
            {
                _error = "Empty response from API.";
                return;
            }

            Session.SetSession(_model.TenantName, _model.Email, response.AccessToken, response.RefreshToken, response.RefreshTokenExpiresAt);
            await Session.PersistAsync(JsRuntime);
            Nav.NavigateTo("/");
        }
        catch (NavigationException)
        {
            throw;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private sealed record RegisterModel(string TenantName, string Email, string DisplayName, string Password)
    {
        public string TenantName { get; set; } = TenantName;
        public string Email { get; set; } = Email;
        public string DisplayName { get; set; } = DisplayName;
        public string Password { get; set; } = Password;
    }
}
