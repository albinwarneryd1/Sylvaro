@page "/security-center"
@using System.Security.Cryptography
@inject Normyx.Web.Services.NormyxApiClient Api
@inject Normyx.Web.Services.AuthSession Session

<PageTitle>Security Center - Normyx AI</PageTitle>

@if (!Session.IsInitialized)
{
    <div class="card-shell"><p>Restoring secure session...</p></div>
}
else if (!Session.IsAuthenticated)
{
    <div class="card-shell"><p>Authentication required. Use <a href="/login">Sign In</a> to access security controls.</p></div>
}
else
{
    <div class="section-head">
        <div>
            <h1>Security Center</h1>
            <p>Session governance, access hardening and machine-to-machine token controls.</p>
        </div>
        <div class="status-line">
            <span class="risk-pill info">MFA Status: Planned</span>
            <span class="risk-pill success">Password Policy: Enforced</span>
            <span class="risk-pill warning">Active Sessions: @_activeSessions.Count</span>
        </div>
    </div>

    <div class="grid-cards">
        <section class="card-shell">
            <h2>Session Management</h2>
            <ul>
                <li>Last login: @FormatTimestamp(Session.LastAuthenticatedAt)</li>
                <li>Refresh token expiry: @FormatTimestamp(Session.RefreshTokenExpiresAt)</li>
                <li>Session policy: 60 min idle timeout (target policy)</li>
            </ul>
            <div class="btn-row">
                <button class="btn-small" @onclick="RefreshSessionsAsync" disabled="_loadingSessions">Refresh Sessions</button>
                <button class="btn-small" @onclick="RevokeOtherSessionsAsync" disabled="_loadingSessions">Force Logout Other Sessions</button>
            </div>
            @if (!string.IsNullOrWhiteSpace(_sessionMessage))
            {
                <p>@_sessionMessage</p>
            }
            @if (!string.IsNullOrWhiteSpace(_error))
            {
                <div class="alert-danger">@_error</div>
            }
            <table class="table-shell">
                <thead><tr><th>Session</th><th>IP</th><th>User Agent</th><th>Started</th><th>Expires</th><th>Status</th><th></th></tr></thead>
                <tbody>
                    @if (_loadingSessions)
                    {
                        <tr>
                            <td colspan="7">Loading sessions...</td>
                        </tr>
                    }
                    else if (_activeSessions.Count == 0)
                    {
                        <tr>
                            <td colspan="7">No active refresh sessions found.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in _activeSessions)
                        {
                            <tr>
                                <td>@item.SessionRef</td>
                                <td>@item.Ip</td>
                                <td>@TrimUserAgent(item.UserAgent)</td>
                                <td>@item.CreatedAt.ToString("u")</td>
                                <td>@item.ExpiresAt.ToString("u")</td>
                                <td><span class="risk-pill info">Active</span></td>
                                <td><button class="btn-small" @onclick="() => RevokeSessionAsync(item.Id)" disabled="_loadingSessions">Force Logout</button></td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </section>

        <section class="card-shell">
            <h2>Authentication Hardening</h2>
            <label><InputCheckbox @bind-Value="_mfaPlaceholder" disabled="true" /> Require MFA for privileged roles (MVP placeholder)</label>
            <ul>
                <li>Minimum password length: 12 characters</li>
                <li>Complexity rule: upper/lower/number/symbol</li>
                <li>Rotation policy: every 90 days for admin users</li>
                <li>Audit events: login success/failure + token lifecycle</li>
            </ul>
        </section>

        <section class="card-shell metric-card wide">
            <h2>API Tokens Management</h2>
            <p>Issue scoped integration tokens for automation pipelines. Tokens are masked after creation.</p>
            <div class="field-grid">
                <InputText @bind-Value="_tokenName" class="text-input" placeholder="Token name" />
                <InputSelect @bind-Value="_tokenScope" class="text-input">
                    <option value="read:all">read:all</option>
                    <option value="write:actions">write:actions</option>
                    <option value="export:reports">export:reports</option>
                </InputSelect>
            </div>
            <div class="btn-row">
                <button class="btn-small" @onclick="CreateToken">Create Token</button>
            </div>

            <table class="table-shell">
                <thead><tr><th>Name</th><th>Scope</th><th>Created</th><th>Token Ref</th><th></th></tr></thead>
                <tbody>
                    @foreach (var token in _tokens)
                    {
                        <tr>
                            <td>@token.Name</td>
                            <td>@token.Scope</td>
                            <td>@token.CreatedAt.ToString("u")</td>
                            <td>@token.TokenRef</td>
                            <td><button class="btn-small" @onclick="() => RevokeToken(token.Id)">Revoke</button></td>
                        </tr>
                    }
                </tbody>
            </table>
        </section>
    </div>
}

@code {
    private bool _mfaPlaceholder;
    private bool _loadingSessions;
    private string _tokenName = "integration-token";
    private string _tokenScope = "read:all";
    private string _error = string.Empty;
    private string _sessionMessage = string.Empty;

    private List<Normyx.Web.Models.SecuritySessionDto> _activeSessions = [];

    private readonly List<TokenRow> _tokens = [];

    protected override async Task OnInitializedAsync()
    {
        if (!Session.IsAuthenticated)
        {
            return;
        }

        await RefreshSessionsAsync();
    }

    private async Task RefreshSessionsAsync()
    {
        try
        {
            _loadingSessions = true;
            _error = string.Empty;
            _sessionMessage = string.Empty;
            _activeSessions = (await Api.GetAsync<List<Normyx.Web.Models.SecuritySessionDto>>("/security/sessions")) ?? [];
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loadingSessions = false;
        }
    }

    private async Task RevokeSessionAsync(Guid sessionId)
    {
        try
        {
            _loadingSessions = true;
            _error = string.Empty;
            await Api.DeleteAsync($"/security/sessions/{sessionId}");
            await RefreshSessionsAsync();
            _sessionMessage = "Selected session has been revoked.";
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loadingSessions = false;
        }
    }

    private async Task RevokeOtherSessionsAsync()
    {
        try
        {
            _loadingSessions = true;
            _error = string.Empty;
            await Api.PostAsync("/security/sessions/revoke-others", new
            {
                currentRefreshToken = Session.RefreshToken
            });
            await RefreshSessionsAsync();
            _sessionMessage = "All other active sessions have been revoked.";
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loadingSessions = false;
        }
    }

    private void CreateToken()
    {
        if (string.IsNullOrWhiteSpace(_tokenName))
        {
            return;
        }

        var tokenBytes = RandomNumberGenerator.GetBytes(24);
        var tokenRef = Convert.ToBase64String(tokenBytes);
        _tokens.Insert(0, new TokenRow(Guid.NewGuid(), _tokenName.Trim(), _tokenScope, DateTimeOffset.UtcNow, $"nxa_{tokenRef[..10]}..."));
        _tokenName = "integration-token";
    }

    private void RevokeToken(Guid id)
    {
        _tokens.RemoveAll(x => x.Id == id);
    }

    private static string FormatTimestamp(DateTimeOffset value)
        => value == default ? "n/a" : value.UtcDateTime.ToString("yyyy-MM-dd HH:mm:ss 'UTC'");

    private static string TrimUserAgent(string userAgent)
    {
        if (string.IsNullOrWhiteSpace(userAgent))
        {
            return "unknown";
        }

        return userAgent.Length <= 72 ? userAgent : $"{userAgent[..72]}...";
    }

    private sealed record TokenRow(Guid Id, string Name, string Scope, DateTimeOffset CreatedAt, string TokenRef);
}
