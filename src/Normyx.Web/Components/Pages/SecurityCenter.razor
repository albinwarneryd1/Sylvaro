@page "/security-center"
@inject Normyx.Web.Services.NormyxApiClient Api
@inject Normyx.Web.Services.AuthSession Session

<PageTitle>Security Center - Normyx AI</PageTitle>

@if (!Session.IsInitialized)
{
    <div class="card-shell"><p>Restoring secure session...</p></div>
}
else if (!Session.IsAuthenticated)
{
    <div class="card-shell"><p>Authentication required. Use <a href="/login">Sign In</a> to access security controls.</p></div>
}
else
{
    <div class="section-head">
        <div>
            <h1>Security Center</h1>
            <p>Session governance, access hardening and machine-to-machine token controls.</p>
        </div>
        <div class="status-line">
            <span class="risk-pill info">MFA Status: Planned</span>
            <span class="risk-pill success">Password Policy: Enforced</span>
            <span class="risk-pill warning">Active Sessions: @_activeSessions.Count</span>
            <span class="risk-pill info">Available Roles: @_roles.Count</span>
            <span class="@($"risk-pill {(_rateLimitPolicy?.IsActive == true ? "success" : "warning")}")">Rate Limiting: @(_rateLimitPolicy?.IsActive == true ? "Active" : "Unavailable")</span>
        </div>
    </div>

    <div class="grid-cards">
        <section class="card-shell">
            <h2>Session Management</h2>
            <ul>
                <li>Last login: @FormatTimestamp(Session.LastAuthenticatedAt)</li>
                <li>Refresh token expiry: @FormatTimestamp(Session.RefreshTokenExpiresAt)</li>
                <li>Session policy: 60 min idle timeout (target policy)</li>
            </ul>
            <div class="btn-row">
                <button class="btn-small" @onclick="RefreshSessionsAsync" disabled="_loadingSessions">Refresh Sessions</button>
                <button class="btn-small" @onclick="RevokeOtherSessionsAsync" disabled="_loadingSessions">Force Logout Other Sessions</button>
            </div>
            @if (!string.IsNullOrWhiteSpace(_sessionMessage))
            {
                <p>@_sessionMessage</p>
            }
            @if (!string.IsNullOrWhiteSpace(_error))
            {
                <EnterpriseErrorPanel ErrorText="@_error" FriendlyMessage="Security operation failed." OnRetry="RetrySecurityAsync" />
            }
            <table class="table-shell">
                <thead><tr><th>Session</th><th>IP</th><th>User Agent</th><th>Started</th><th>Expires</th><th>Status</th><th></th></tr></thead>
                <tbody>
                    @if (_loadingSessions)
                    {
                        <tr>
                            <td colspan="7">Loading sessions...</td>
                        </tr>
                    }
                    else if (_activeSessions.Count == 0)
                    {
                        <tr>
                            <td colspan="7">No active refresh sessions found.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in _activeSessions)
                        {
                            <tr>
                                <td>@item.SessionRef</td>
                                <td>@item.Ip</td>
                                <td>@TrimUserAgent(item.UserAgent)</td>
                                <td>@item.CreatedAt.ToString("u")</td>
                                <td>@item.ExpiresAt.ToString("u")</td>
                                <td><span class="risk-pill info">Active</span></td>
                                <td><button class="btn-small" @onclick="() => RevokeSessionAsync(item.Id)" disabled="_loadingSessions">Force Logout</button></td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </section>

        <section class="card-shell">
            <h2>Authentication Hardening</h2>
            <label><InputCheckbox @bind-Value="_mfaPlaceholder" disabled="true" /> Require MFA for privileged roles (MVP placeholder)</label>
            <ul>
                <li>Minimum password length: 12 characters</li>
                <li>Complexity rule: upper/lower/number/symbol</li>
                <li>Rotation policy: every 90 days for admin users</li>
                <li>Audit events: login success/failure + token lifecycle</li>
            </ul>
        </section>

        <section class="card-shell">
            <h2>Role & API Protection Overview</h2>
            <ul>
                @foreach (var role in _roles)
                {
                    <li>@role.Name</li>
                }
            </ul>
            <h3>Rate Limiting Policy</h3>
            <ul>
                <li>Global API quota: @(_rateLimitPolicy?.GlobalPermitLimitPerMinute ?? 200) requests / minute per client IP</li>
                <li>Authentication endpoints: @(_rateLimitPolicy?.AuthPermitLimitPerMinute ?? 20) requests / minute per client IP</li>
                <li>Evaluation window: @(_rateLimitPolicy?.WindowSeconds ?? 60) seconds</li>
                <li>429 responses are audited with correlation IDs</li>
            </ul>
        </section>

        <section class="card-shell metric-card wide">
            <h2>API Tokens Management</h2>
            <p>Issue scoped integration tokens for automation pipelines. Tokens are masked after creation.</p>
            <div class="field-grid">
                <InputText @bind-Value="_tokenName" class="text-input" placeholder="Token name" />
                <InputSelect @bind-Value="_tokenScope" class="text-input">
                    <option value="read:all">read:all</option>
                    <option value="write:actions">write:actions</option>
                    <option value="export:reports">export:reports</option>
                </InputSelect>
            </div>
            <div class="btn-row">
                <button class="btn-small" @onclick="CreateTokenAsync" disabled="_loadingTokens">@(_loadingTokens ? "Creating..." : "Create Token")</button>
                <button class="btn-small" @onclick="RefreshApiTokensAsync" disabled="_loadingTokens">Refresh Tokens</button>
            </div>
            @if (!string.IsNullOrWhiteSpace(_tokenMessage))
            {
                <p>@_tokenMessage</p>
            }
            @if (!string.IsNullOrWhiteSpace(_newTokenValue))
            {
                <div class="alert-danger">Copy this token now (shown once): <strong>@_newTokenValue</strong></div>
            }

            <table class="table-shell">
                <thead><tr><th>Name</th><th>Scope</th><th>Created</th><th>Token Ref</th><th>Status</th><th></th></tr></thead>
                <tbody>
                    @if (_loadingTokens)
                    {
                        <tr>
                            <td colspan="6">Loading tokens...</td>
                        </tr>
                    }
                    else if (_tokens.Count == 0)
                    {
                        <tr>
                            <td colspan="6">No API tokens provisioned.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var token in _tokens)
                        {
                            <tr>
                                <td>@token.Name</td>
                                <td>@token.Scope</td>
                                <td>@token.CreatedAt.ToString("u")</td>
                                <td>@token.TokenPrefix</td>
                                <td><span class="@($"risk-pill {(token.RevokedAt is null ? "success" : "warning")}")">@(token.RevokedAt is null ? "Active" : "Revoked")</span></td>
                                <td><button class="btn-small" @onclick="() => RevokeTokenAsync(token.Id)" disabled="_loadingTokens || token.RevokedAt is not null">Revoke</button></td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </section>
    </div>
}

@code {
    private bool _mfaPlaceholder;
    private bool _loadingSessions;
    private bool _loadingTokens;
    private string _tokenName = "integration-token";
    private string _tokenScope = "read:all";
    private string _error = string.Empty;
    private string _sessionMessage = string.Empty;
    private string _tokenMessage = string.Empty;
    private string _newTokenValue = string.Empty;

    private List<Normyx.Web.Models.SecuritySessionDto> _activeSessions = [];
    private List<Normyx.Web.Models.ApiTokenDto> _tokens = [];
    private List<Normyx.Web.Models.RoleDto> _roles = [];
    private Normyx.Web.Models.RateLimitPolicyDto? _rateLimitPolicy;
    private bool _attemptedInitialLoad;

    protected override async Task OnInitializedAsync()
    {
        if (!Session.IsAuthenticated)
        {
            return;
        }

        _attemptedInitialLoad = true;
        await RefreshSessionsAsync();
        await RefreshApiTokensAsync();
        await LoadRolesAsync();
        await LoadRateLimitPolicyAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_attemptedInitialLoad || !Session.IsInitialized || !Session.IsAuthenticated)
        {
            return;
        }

        _attemptedInitialLoad = true;
        await RefreshSessionsAsync();
        await RefreshApiTokensAsync();
        await LoadRolesAsync();
        await LoadRateLimitPolicyAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshSessionsAsync()
    {
        try
        {
            _loadingSessions = true;
            _error = string.Empty;
            _sessionMessage = string.Empty;
            _activeSessions = (await Api.GetAsync<List<Normyx.Web.Models.SecuritySessionDto>>("/security/sessions")) ?? [];
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loadingSessions = false;
        }
    }

    private async Task RefreshApiTokensAsync()
    {
        try
        {
            _loadingTokens = true;
            _error = string.Empty;
            _tokenMessage = string.Empty;
            _newTokenValue = string.Empty;
            _tokens = (await Api.GetAsync<List<Normyx.Web.Models.ApiTokenDto>>("/security/api-tokens")) ?? [];
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loadingTokens = false;
        }
    }

    private async Task LoadRolesAsync()
    {
        try
        {
            _roles = (await Api.GetAsync<List<Normyx.Web.Models.RoleDto>>("/tenants/roles")) ?? [];
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task LoadRateLimitPolicyAsync()
    {
        try
        {
            _rateLimitPolicy = await Api.GetAsync<Normyx.Web.Models.RateLimitPolicyDto>("/security/rate-limit-policy");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task RevokeSessionAsync(Guid sessionId)
    {
        try
        {
            _loadingSessions = true;
            _error = string.Empty;
            await Api.DeleteAsync($"/security/sessions/{sessionId}");
            await RefreshSessionsAsync();
            _sessionMessage = "Selected session has been revoked.";
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loadingSessions = false;
        }
    }

    private async Task RevokeOtherSessionsAsync()
    {
        try
        {
            _loadingSessions = true;
            _error = string.Empty;
            await Api.PostAsync("/security/sessions/revoke-others", new
            {
                currentRefreshToken = Session.RefreshToken
            });
            await RefreshSessionsAsync();
            _sessionMessage = "All other active sessions have been revoked.";
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loadingSessions = false;
        }
    }

    private async Task CreateTokenAsync()
    {
        if (string.IsNullOrWhiteSpace(_tokenName))
        {
            return;
        }

        try
        {
            _loadingTokens = true;
            _error = string.Empty;
            _tokenMessage = string.Empty;
            _newTokenValue = string.Empty;

            var result = await Api.PostAsync<Normyx.Web.Models.ApiTokenCreateResult>("/security/api-tokens", new
            {
                name = _tokenName,
                scope = _tokenScope
            });

            if (result is null)
            {
                _error = "API token provisioning failed.";
                return;
            }

            _newTokenValue = result.TokenValue;
            _tokenMessage = "API token was provisioned. Store token value in your secret manager.";
            _tokenName = "integration-token";
            await RefreshApiTokensAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loadingTokens = false;
        }
    }

    private async Task RevokeTokenAsync(Guid id)
    {
        try
        {
            _loadingTokens = true;
            _error = string.Empty;
            _tokenMessage = string.Empty;
            _newTokenValue = string.Empty;
            await Api.DeleteAsync($"/security/api-tokens/{id}");
            _tokenMessage = "API token revoked.";
            await RefreshApiTokensAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loadingTokens = false;
        }
    }

    private static string FormatTimestamp(DateTimeOffset value)
        => value == default ? "n/a" : value.UtcDateTime.ToString("yyyy-MM-dd HH:mm:ss 'UTC'");

    private static string TrimUserAgent(string userAgent)
    {
        if (string.IsNullOrWhiteSpace(userAgent))
        {
            return "unknown";
        }

        return userAgent.Length <= 72 ? userAgent : $"{userAgent[..72]}...";
    }

    private async Task RetrySecurityAsync()
    {
        await RefreshSessionsAsync();
        await RefreshApiTokensAsync();
        await LoadRolesAsync();
        await LoadRateLimitPolicyAsync();
    }
}
